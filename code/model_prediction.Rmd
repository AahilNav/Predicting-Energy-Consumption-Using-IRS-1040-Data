---
title: "Model prediction"
author: "Aahil Navroz, Joseph Williams, Qi Suqian"
date: "`r Sys.Date()`"
output: html_document
---

### Data Wrangling: aggregating, combining Chicago energy with IRS

Aahil Navroz, Joseph Williams, Qi Suqian

```{r, message=FALSE, echo=FALSE, warning=FALSE}
set.seed(17)
library(caret)
library(randomForest)
library(gbm)
library(xgboost)
library(yardstick)
library(Metrics)
library(ggplot2)
library(pdp)
```

```{r, message=FALSE, echo=FALSE, warning=FALSE}
# read the dataset
chi_all = read.csv("../working_data/chi_all.csv")
chi_singlefam = read.csv("../working_data/chi_singlefam.csv")

# delet the missing value rows and abnormal rows
cleaned_all = na.omit(chi_all)
cleaned_all = cleaned_all[!cleaned_all$TOTAL.POPULATION==0,]
cleaned_fam = na.omit(chi_singlefam)
cleaned_fam = cleaned_all[!cleaned_fam$TOTAL.POPULATION==0,]

# choose the selected columns
cleaned_all = cleaned_all[,-c(1,2,3,6,7,8,9,10,11,12,14,15,16,17,18,19,21,28,29)]
cleaned_fam = cleaned_fam[,-c(1,2,3,6,7,8,9,10,11,12,14,15,16,17,18,19,21,28,29)]

# seperate two target variables: THERMS.SQFT.MEAN.2010 and KWH.MEAN.2010
therm_all = cleaned_all[,-4]
kwh_all = cleaned_all[,-3]
therm_fam = cleaned_fam[,-4]
kwh_fam = cleaned_fam[,-3]

# split the dataset into train and test set
train_index_therm_all = createDataPartition(therm_all$THERMS.SQFT.MEAN.2010, p = 0.8, list = FALSE)
train_therm_all = therm_all[train_index_therm_all, ]
test_therm_all = therm_all[-train_index_therm_all, ]
```

```{r, message=FALSE, echo=FALSE, warning=FALSE}
## perfrom model fitting for therm_all
# split the dataset into train and test set
train_index_therm_all = createDataPartition(therm_all$THERMS.SQFT.MEAN.2010, p = 0.8, list = FALSE)
train_therm_all = therm_all[train_index_therm_all, ]
test_therm_all = therm_all[-train_index_therm_all, ]

# Randomforest
rf_therm_all= randomForest(THERMS.SQFT.MEAN.2010~ ., data = train_therm_all, ntree = 1000)

# GBM
trainControl_gbm_therm_all = trainControl(method = "cv",  
                               number = 20)    
gbm_grid = expand.grid(interaction.depth = 1:8,  
                          n.trees = 1000,          
                          shrinkage = c(0.001, 0.005, 0.01, 0.05, 0.1),
                        n.minobsinnode = c(4,6,8,10))
gbm_therm_all_train = train(THERMS.SQFT.MEAN.2010 ~ ., data = train_therm_all,
                    method = "gbm",
                    trControl = trainControl_gbm_therm_all,
                    tuneGrid = gbm_grid,
                    verbose = FALSE,
                    metric = "RMSE",  
                    distribution = "gaussian")
print(gbm_therm_all_train)
gbm_therm_all = gbm(THERMS.SQFT.MEAN.2010 ~ ., data = train_therm_all, distribution = "gaussian", 
                n.trees=1000,interaction.depth = 6,shrinkage = 0.1,n.minobsinnode = 4)

# XGboost
xtherm_all = xgb.DMatrix(data=as.matrix(train_therm_all[,-3]),label=train_therm_all[,3])
xgb_grid = expand.grid(max_depth = c(4, 6, 8, 10),  # Example depths
                           subsample = c(0.5, 0.7, 0.9),  # Example subsample rates
                           eta = c(0.005, 0.01, 0.05, 0.1),  # Example learning rates
                           stringsAsFactors = FALSE)

# Initialize variables to store the best parameters and lowest RMSE
best_params_therm_all = list()
min_rmse_therm_all = Inf
 
# Loop through the grid
for(i in 1:nrow(xgb_grid)) {
   params = list(
     booster = "gbtree",
     max_depth = xgb_grid$max_depth[i],
     subsample = xgb_grid$subsample[i],
     eta = xgb_grid$eta[i]
   )
   
# Perform cross-validation
   cv = xgb.cv(
     params = params,
     data = xtherm_all,
     nrounds = 10000,
     nfold = 5,  
     watchlist = list(train = xtherm_all),
     early_stopping_rounds = 10,
     metrics = "rmse",
     maximize = FALSE  
   )
   
# Check if this model has the lowest RMSE so far
   if(cv$evaluation_log$test_rmse_mean[cv$best_iteration] < min_rmse_therm_all) {
     min_rmse_therm_all = cv$evaluation_log$test_rmse_mean[cv$best_iteration]
     best_params_therm_all = params
   }
 }
 
#print the best params
print(best_params_therm_all)

xgb_therm_all = xgb.train(booster = "gbtree", max_depth = 10, subsample = 0.5, eta = 0.01, data = xtherm_all,
                       nrounds = 10000, watchlist = list(train = xtherm_all),
                       early_stopping_rounds = 10,verbose = 0)

# compare performance of three tree models
ytherm_all = xgb.DMatrix(data=as.matrix(test_therm_all[,-3]),label=test_therm_all[,3])
rf_predict_therm_all = predict(rf_therm_all,newdata=test_therm_all[,-3])
gbm_predict_therm_all = predict(gbm_therm_all,newdata=test_therm_all[,-3])
xgb_predict_therm_all = predict(xgb_therm_all,newdata=ytherm_all)
therm_all_result = as.data.frame(cbind(test_therm_all$THERMS.SQFT.MEAN.2010,rf_predict_therm_all,gbm_predict_therm_all,xgb_predict_therm_all))

rf_rmse_therm_all = rmse(therm_all_result,V1,rf_predict_therm_all)
gbm_rmse_therm_all = rmse(therm_all_result,V1,gbm_predict_therm_all)
xgb_rmse_therm_all = rmse(therm_all_result,V1,xgb_predict_therm_all)

rf_msle_therm_all = msle(test_therm_all$THERMS.SQFT.MEAN.2010,rf_predict_therm_all)
gbm_msle_therm_all = msle(test_therm_all$THERMS.SQFT.MEAN.2010,gbm_predict_therm_all)
xgb_msle_therm_all = msle(test_therm_all$THERMS.SQFT.MEAN.2010,xgb_predict_therm_all)

rf_mpe_therm_all = mpe(therm_all_result,V1,rf_predict_therm_all)
gbm_mpe_therm_all = mpe(therm_all_result,V1,gbm_predict_therm_all)
xgb_mpe_therm_all = mpe(therm_all_result,V1,xgb_predict_therm_all)

therm_all_rmse_value = c(rf_rmse_therm_all$.estimate,gbm_rmse_therm_all$.estimate,xgb_rmse_therm_all$.estimate)
therm_all_msle_value = c(rf_msle_therm_all,gbm_msle_therm_all,xgb_msle_therm_all)
therm_all_mpe_value = c(rf_mpe_therm_all$.estimate,gbm_mpe_therm_all$.estimate,xgb_mpe_therm_all$.estimate)

print(therm_all_rmse_value)
print(therm_all_msle_value)
print(therm_all_mpe_value)

```

```{r, message=FALSE, echo=FALSE, warning=FALSE}
ggplot(mapping = aes(x = 1:nrow(therm_all_result))) +
  geom_line(aes(y = therm_all_result$V1), color = "black") +
  geom_line(aes(y = therm_all_result$rf_predict_therm_all), color = "blue") +
  geom_line(aes(y = therm_all_result$gbm_predict_therm_all), color = "green") +
  geom_line(aes(y = therm_all_result$xgb_predict_therm_all), color = "red") +
  labs(title = "Line Plot with Multiple Lines",
       x = "Row number", y = "Y-axis",
       color = "Lines") +
  theme_minimal()
```