---
title: "Project Analysis Exploratory"
author: "Aahil Navroz, Joseph Williams, Qi Suqian"
date: "`r Sys.Date()`"
output: html_document
---

# ECO 395M: Exploratory Analysis: Who is claiming energy tax credits

Aahil Navroz, Joseph Williams, Qi Suqian

```{r, message=FALSE, echo=FALSE, warning=FALSE}
#Joe Code

library(tidyverse)
library(ggplot2)
library(maps)
library(readxl)

options(scipen = 16)

#unzip below folder first
chicago = read.csv("../working_data/final_updated_energy_usage_with_coordinates.csv")

# varnames
varnames = read_excel("../artifacts/Codebook.xlsx","SelectedVars") %>% select(Variable, Description, Shared)


##Chicago data wrangling

#add datatype
#filter out residential and put description information first
chicago_check = chicago %>% filter(BUILDING.TYPE=="Residential") %>% select(zip, BUILDING_SUBTYPE, KWH.JANUARY.2010) %>% arrange(zip, BUILDING_SUBTYPE)


##Chicago ZIP Totals
chicago_filt = chicago %>%
  filter(BUILDING.TYPE == "Residential") %>%
  group_by(zip, BUILDING_SUBTYPE, Latitude, Longitude) %>%
  summarize(
    across(c(THERM.JANUARY.2010, THERM.FEBRUARY.2010, THERM.NOVEMBER.2010, THERM.DECEMBER.2010, TOTAL.THERMS,THERMS.TOTAL.SQFT, THERMS.SQFT.STANDARD.DEVIATION.2010, THERMS.TOTAL.SQFT, THERMS.SQFT.MEAN.2010,KWH.JANUARY.2010, KWH.FEBRUARY.2010, KWH.NOVEMBER.2010, KWH.DECEMBER.2010, TOTAL.KWH, KWH.TOTAL.SQFT, KWH.MEAN.2010, KWH.SQFT.STANDARD.DEVIATION.2010, TOTAL.POPULATION, TOTAL.UNITS, OCCUPIED.HOUSING.UNITS, RENTER.OCCUPIED.HOUSING.UNITS), sum, na.rm = TRUE),
    across(
      c(AVERAGE.STORIES, AVERAGE.BUILDING.AGE),mean,na.rm = TRUE)
  )

#optional data wrangling
#maybe weight each row by proportion of units in zip that are owned.  Can get this by (housing.units.occupied-housing.units.rented)/housing.units.occupied

##Next steps
#either sum all building.subtype for zip totals (reperform previous step without groupby(building.subtype)) [lets do this first] or filter out building.subtype != single_family [we can try this if we have time]

#Cbind with IRS df below for master... I'm thinking we run analysis on owned, residential, and owned, all.  You'll


##############################################################################
##IRS data wrangling
  
#list of unique Chicago area codes for summary.
chicago_zips = chicago %>%
  filter(!is.na(zip))
chicago_ziplist = unique(chicago_zips$zip)

#filter to only contain observations with Chicago zipcodes
irs09 = read.csv("../working_data/09zpallagi_stdz.csv")
irs09c <- irs09 %>% 
  filter(ZIPCODE %in% chicago_ziplist)

# Group by ZIPCODE and summarize numeric columns

# irs_counts <- irs09 %>%
#  select(-c(STATEFIPS, AGI_STUB)) %>%
#   group_by(STATE, YEAR, ZIPCODE) %>%
#   summarize(across(where(is.numeric), sum, na.rm = TRUE))

irs09c_counts <- irs09c %>%
 select(-c(N10960, A10960, N11520, A11520, STATEFIPS, AGI_STUB)) %>%
  group_by(STATE, YEAR, ZIPCODE) %>%
  summarize(across(where(is.numeric), sum, na.rm = TRUE))

#Which varaibles now excluded?
irs_counts_cols <- colnames(irs_counts)
varnames_vars <- varnames$Variable

# Find variables in Varnames missing from counts
not_in_counts <- setdiff(varnames_vars, irs_counts_cols)

# Print variables in Varnames missing from counts
#print(not_in_counts)

#Calculate averages and order intuitiveley

# irs09_varcounts = irs_counts[, -c(1,2,3,5,6,7)]
# irs09_varcounts <- irs09_varcounts %>%
#   mutate(across(-N1, ~ ./N1, .names = "{.col}_av"))
# var_columns <- grep("_av$", colnames(irs09_varcounts), value = TRUE)
# var_columns <- sub("_av$", "", var_columns)
# column_pairs <- c(rbind(var_columns, paste0(var_columns, "_av")))
# irs09_varcounts <- irs09_varcounts %>%
#   select(N1, column_pairs, everything())

irs09c_varcounts = irs09c_counts[, -c(1,2,3,5,6,7)]
irs09c_varcounts <- irs09c_varcounts %>%
  mutate(across(-N1, ~ ./N1, .names = "{.col}_av"))
var_columns <- grep("_av$", colnames(irs09c_varcounts), value = TRUE)
var_columns <- sub("_av$", "", var_columns)
column_pairs <- c(rbind(var_columns, paste0(var_columns, "_av")))
irs09c_varcounts <- irs09c_varcounts %>%
  select(N1, column_pairs, everything())

#Recreate df
#irs09_us <- cbind(irs_counts[, 1:7], irs09_varcounts[, -1])
irs09chi <- cbind(irs09c_counts[, 1:7], irs09c_varcounts[, -1])

#Output 09 data
#write.csv(irs09_us, "../working_data/irs09_us.csv", row.names = FALSE)








```